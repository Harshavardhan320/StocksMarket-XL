name: Create Daily Holdings Branch

on:
  schedule:
    # 9:30 AM IST = 04:00 UTC
    - cron: "0 4 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  create-branch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Create holdings branch
        id: branch
        run: |
          DATE=$(date -u -d "+5 hours 30 minutes" +"%d")
          MONTH=$(date -u -d "+5 hours 30 minutes" +"%B" | tr '[:upper:]' '[:lower:]')
          YEAR=$(date -u -d "+5 hours 30 minutes" +"%Y")
          DAY=$(date -u -d "+5 hours 30 minutes" +"%A")
          TIME=$(date -u -d "+5 hours 30 minutes" "+%d %B %Y, %I:%M %p IST")

          BRANCH="holdings-${DATE}-${MONTH}-${YEAR}"

          git checkout -b "$BRANCH"
          git push origin "$BRANCH"

          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "day=$DAY" >> $GITHUB_OUTPUT
          echo "time=$TIME" >> $GITHUB_OUTPUT

      - name: Send Telegram Notification (Branch Created)
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          WEEKEND_NOTE=""
          if [[ "${{ steps.branch.outputs.day }}" == "Saturday" || "${{ steps.branch.outputs.day }}" == "Sunday" ]]; then
            WEEKEND_NOTE="‚ö†Ô∏è <b>Note:</b> This is a weekend branch."
          fi

          MESSAGE=$(
            printf "<b>üìå DAILY HOLDINGS BRANCH CREATED</b>\n\n"
            printf "üëã Dear Team,\n\n"
            printf "A new daily holdings branch has been created successfully.\n\n"
            printf "üßæ <b>Branch Name:</b> %s\n" "${{ steps.branch.outputs.branch }}"
            printf "üïò <b>Created At:</b> %s\n" "${{ steps.branch.outputs.time }}"
            printf "üìÖ <b>Day:</b> %s\n\n" "${{ steps.branch.outputs.day }}"
            printf "%s\n\n" "$WEEKEND_NOTE"
            printf "ü§ñ Fun Market Automation System"
          )

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode=HTML \
            --data-urlencode text="$MESSAGE"
