name: Cleanup Empty Holdings Branch

on:
  schedule:
    - cron: "30 15 * * *"   # 9:00 PM IST
  workflow_dispatch:

permissions:
  contents: write

jobs:
  cleanup-branch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Check and delete empty branch
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          DATE=$(date -u -d "+5 hours 30 minutes" +"%d")
          MONTH=$(date -u -d "+5 hours 30 minutes" +"%B" | tr '[:upper:]' '[:lower:]')
          YEAR=$(date -u -d "+5 hours 30 minutes" +"%Y")
          DAY=$(date -u -d "+5 hours 30 minutes" +"%A")

          BRANCH="holdings-${DATE}-${MONTH}-${YEAR}"
          CHECK_TIME=$(date -u -d "+5 hours 30 minutes" "+%d %B %Y, %I:%M %p IST")

          if ! git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
            echo "Branch does not exist. Exiting."
            exit 0
          fi

          git fetch origin "$BRANCH"
          COMMITS=$(git rev-list --count origin/main..origin/"$BRANCH")

          if [ "$COMMITS" -eq 0 ]; then
            git push origin --delete "$BRANCH"

            MESSAGE=$(
              printf "Subject: Empty Holdings Branch Deleted\n\n"
              printf "Dear Team,\n\n"
              printf "The following holdings branch was deleted as no commits were made.\n\n"
              printf "Branch Name: %s\n" "$BRANCH"
              printf "Checked On: %s (%s)\n\n" "$CHECK_TIME" "$DAY"
              printf "Reason: No commits found during the day.\n\n"
              printf "Regards,\nFun Market Automation System"
            )

            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              --data-urlencode text="$MESSAGE"
          fi
