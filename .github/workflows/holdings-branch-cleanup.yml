name: Cleanup Empty Holdings Branch

on:
  schedule:
    # 9:00 PM IST = 15:30 UTC
    - cron: "30 15 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  cleanup-branch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Check and delete empty holdings branch
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          DATE=$(date -u -d "+5 hours 30 minutes" +"%d")
          MONTH=$(date -u -d "+5 hours 30 minutes" +"%B" | tr '[:upper:]' '[:lower:]')
          YEAR=$(date -u -d "+5 hours 30 minutes" +"%Y")
          DAY=$(date -u -d "+5 hours 30 minutes" +"%A")
          TIME=$(date -u -d "+5 hours 30 minutes" "+%d %B %Y, %I:%M %p IST")

          BRANCH="holdings-${DATE}-${MONTH}-${YEAR}"

          if ! git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
            echo "Branch does not exist. Nothing to clean."
            exit 0
          fi

          git fetch origin "$BRANCH"
          COMMITS=$(git rev-list --count origin/main..origin/"$BRANCH")

          if [ "$COMMITS" -eq 0 ]; then
            git push origin --delete "$BRANCH"

            MESSAGE=$(
              printf "<b>üóëÔ∏è EMPTY HOLDINGS BRANCH DELETED</b>\n\n"
              printf "üëã Dear Team,\n\n"
              printf "The following holdings branch was deleted as no commits were made during the day.\n\n"
              printf "üßæ <b>Branch Name:</b> %s\n" "$BRANCH"
              printf "üïò <b>Checked At:</b> %s\n" "$TIME"
              printf "üìÖ <b>Day:</b> %s\n\n" "$DAY"
              printf "‚ùó <b>Reason:</b> No commits found.\n\n"
              printf "ü§ñ Fun Market Automation System"
            )

            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d parse_mode=HTML \
              --data-urlencode text="$MESSAGE"
          fi
