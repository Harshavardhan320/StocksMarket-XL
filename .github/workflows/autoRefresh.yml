name: Auto Wake and Refresh All Services

permissions:
  contents: read

on:
  schedule:
    # 10:30 PM IST = 17:00 UTC (runs every day)
    - cron: "0 17 * * *"
  workflow_dispatch:

jobs:
  wake-and-refresh:
    runs-on: ubuntu-latest

    steps:
      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Wake Config Server
        run: |
          curl -s https://funmarketconfigserver-dckt.onrender.com/actuator/health

      - name: Wake DB Connector
        run: |
          curl -s https://funmarketdb.onrender.com/actuator/health

      - name: Wake Git Reader
        run: |
          curl -s https://funmarketgitreader.onrender.com/actuator/health

      - name: Wait for services
        run: |
          sleep 300

      - name: Trigger Git Reader Load
        run: |
          curl -s -X POST https://funmarketgitreader.onrender.com/fun-market/git-reader/read > response.json

      - name: Parse Response and Prepare Outputs
        id: parsed
        run: |
          MESSAGE=$(jq -r '.message // "No message returned"' response.json)
          STATUS=$(jq -r '.httpStatusCode // "NA"' response.json)

          FILE_LIST=$(jq -r '
            if (.data | type) == "array" then
              .data[]
            elif (.data | type) == "string" then
              .data
            else
              empty
            end
          ' response.json)

          if [ -z "$FILE_LIST" ]; then
            FORMATTED_FILES="â€¢ No files processed"
          else
            FORMATTED_FILES=$(echo "$FILE_LIST" | sed 's/^/â€¢ /')
          fi

          DAY=$(date -u -d "+5 hours 30 minutes" +"%A")
          DATE_TIME=$(date -u -d "+5 hours 30 minutes" "+%d %B %Y, %I:%M %p IST")

          ALERT=""
          if [[ "$DAY" == "Saturday" || "$DAY" == "Sunday" ]]; then
            ALERT="ALERT : This execution happened on a weekend."
          fi

          {
            echo "message<<EOF"
            echo "$MESSAGE"
            echo "EOF"

            echo "status=$STATUS"

            echo "files<<EOF"
            echo "$FORMATTED_FILES"
            echo "EOF"

            echo "day=$DAY"
            echo "datetime=$DATE_TIME"

            echo "alert<<EOF"
            echo "$ALERT"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Send Telegram Notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MESSAGE=$(
            printf "<b>ðŸ“¢ FUN MARKET â€“ GIT DATA LOAD SUCCESS</b>\n\n"
            printf "<b>ðŸ—“ Date & Time:</b> %s\n" "${{ steps.parsed.outputs.datetime }}"
            printf "<b>ðŸ“… Day:</b> %s\n\n" "${{ steps.parsed.outputs.day }}"

            if [ -n "${{ steps.parsed.outputs.alert }}" ]; then
              printf "ðŸš¨ <b>%s</b>\n\n" "${{ steps.parsed.outputs.alert }}"
            fi

            printf "<b>âœ… Execution Message:</b>\n"
            printf "<i>%s</i>\n\n" "${{ steps.parsed.outputs.message }}"

            printf "<b>ðŸ“Š Status Code:</b> %s\n\n" "${{ steps.parsed.outputs.status }}"

            printf "<b>ðŸ“‚ Files Processed:</b>\n"
            printf "%s\n\n" "${{ steps.parsed.outputs.files }}"

            printf "<i>ðŸ¤– Fun Market Automation System</i>"
          )

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode=HTML \
            --data-urlencode text="$MESSAGE"
