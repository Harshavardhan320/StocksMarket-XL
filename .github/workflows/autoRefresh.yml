name: Auto Wake and Refresh All Services

permissions:
  contents: read

on:
  schedule:
    # 10:30 PM IST = 17:00 UTC (Monâ€“Fri)
    - cron: "0 17 * * *"
  workflow_dispatch:

jobs:
  wake-and-refresh:
    runs-on: ubuntu-latest

    steps:
      - name: Step 0 - Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Step 1 - Wake Config Server
        run: |
          echo "ðŸ“¡ Waking Config Server"
          curl -s https://funmarketconfigserver-dckt.onrender.com/actuator/health

      - name: Step 2 - Wake DB Connector
        run: |
          echo "ðŸ“¡ Waking DB Connector"
          curl -s https://funmarketdb.onrender.com/actuator/health

      - name: Step 3 - Wake Git Reader
        run: |
          echo "ðŸ“¡ Waking Git Reader"
          curl -s https://funmarketgitreader.onrender.com/actuator/health

      - name: Step 4 - Wait for services
        run: |
          echo "â³ Waiting 5 minutes for services to be fully ready..."
          sleep 300

      - name: Step 5 - Trigger Git Reader Load (WAIT FOR RESPONSE)
        id: load
        run: |
          echo "ðŸš€ Triggering Git Reader data load..."

          RESPONSE=$(curl -s -X POST https://funmarketgitreader.onrender.com/fun-market/git-reader/read)

          echo "$RESPONSE" > response.json
          echo "Full API Response:"
          cat response.json

      - name: Step 6 - Parse Response + Date Info
        id: parsed
        run: |
          MESSAGE=$(jq -r '.message // "No message returned"' response.json)
          STATUS=$(jq -r '.httpStatusCode // "NA"' response.json)
          DATA=$(jq -r '.data // empty' response.json)

          DAY=$(date -u -d "+5 hours 30 minutes" +"%A")
          DATE_TIME=$(date -u -d "+5 hours 30 minutes" "+%d %B %Y, %I:%M %p IST")

          WEEKEND_ALERT=""
          if [[ "$DAY" == "Saturday" || "$DAY" == "Sunday" ]]; then
            WEEKEND_ALERT="âš ï¸ ALERT: This job is running on a weekend."
          fi

          echo "message=$MESSAGE" >> $GITHUB_OUTPUT
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "data=$DATA" >> $GITHUB_OUTPUT
          echo "day=$DAY" >> $GITHUB_OUTPUT
          echo "datetime=$DATE_TIME" >> $GITHUB_OUTPUT
          echo "weekend_alert=$WEEKEND_ALERT" >> $GITHUB_OUTPUT

      - name: Step 7 - Send Telegram Notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MESSAGE=$(
            printf "ðŸ“¢ FUN MARKET â€“ GIT DATA LOAD REPORT\n\n"
            printf "Date & Time : %s\n" "${{ steps.parsed.outputs.datetime }}"
            printf "Day         : %s\n\n" "${{ steps.parsed.outputs.day }}"
            printf "%s\n\n" "${{ steps.parsed.outputs.weekend_alert }}"
            printf "Message     : %s\n" "${{ steps.parsed.outputs.message }}"
            printf "Status Code : %s\n\n" "${{ steps.parsed.outputs.status }}"
            printf "Data Loaded :\n%s\n\n" "${{ steps.parsed.outputs.data }}"
            printf "-- Fun Market Automation System"
          )

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            --data-urlencode text="$MESSAGE"

      - name: Step 8 - Done
        run: echo "âœ… Auto wake & data refresh completed successfully"
