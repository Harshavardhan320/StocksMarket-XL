name: Auto Wake and Refresh All Services

permissions:
  contents: read

on:
  schedule:
    # 11:45 PM IST = 18:15 UTC
    - cron: "15 10 * * 1-5"
  workflow_dispatch:

jobs:
  wake-and-refresh:
    runs-on: ubuntu-latest

    steps:
      - name: Step 0 - Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Step 1 - Wake Config Server
        run: |
          echo "ðŸ“¡ Waking Config Server"
          curl -s https://funmarketconfigserver-dckt.onrender.com/actuator/health

      - name: Step 2 - Wake DB Connector
        run: |
          echo "ðŸ“¡ Waking DB Connector"
          curl -s https://funmarketdb.onrender.com/actuator/health

      - name: Step 3 - Wake Git Reader
        run: |
          echo "ðŸ“¡ Waking Git Reader"
          curl -s https://funmarketgitreader.onrender.com/actuator/health

      - name: Step 4 - Wait for services
        run: |
          echo "â³ Waiting 5 minutes..."
          sleep 300

      - name: Step 5 - Trigger Git Reader Load
        id: load
        run: |
          echo "ðŸš€ Triggering Git Reader load"

          RESPONSE=$(curl -s -X POST https://funmarketgitreader.onrender.com/fun-market/git-reader/read)

          echo "$RESPONSE" > response.json
          echo "response<<EOF" >> $GITHUB_OUTPUT
          cat response.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Step 6 - Parse Response
        id: parsed
        run: |
          MESSAGE=$(jq -r '.message // "No message"' response.json)
          STATUS=$(jq -r '.httpStatusCode // "NA"' response.json)
          FILES=$(jq -r '.data[]? // empty' response.json | tr '\n' ', ')

          [ -z "$FILES" ] && FILES="No files loaded"

          echo "message=$MESSAGE" >> $GITHUB_OUTPUT
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "files=$FILES" >> $GITHUB_OUTPUT

      - name: Step 7 - Send Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          secure: false
          subject: Fun Market - Git Data Load Report
          to: funstockmarket365@gmail.com,katukojwalaharshavardhan97@gmail.com,ankithachikki123@gmail.com
          from: Fun Market Bot <sunnyharsha320@gmail.com>
          body: |
            Hello Team,

            Git Reader refresh completed at 11:45 PM IST.

            Message:
            ${{ steps.parsed.outputs.message }}

            Status:
            ${{ steps.parsed.outputs.status }}

            Files Loaded:
            ${{ steps.parsed.outputs.files }}

            Regards,
            Fun Market Automation System

      - name: Step 8 - Send Telegram Message
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MESSAGE=$(
            printf "ðŸ“¢ Fun Market â€“ Git Data Load Report\n\n"
            printf "Time: 11:45 PM IST\n\n"
            printf "Message: %s\n\n" "${{ steps.parsed.outputs.message }}"
            printf "Status: %s\n\n" "${{ steps.parsed.outputs.status }}"
            printf "Files Loaded:\n%s\n\n" "${{ steps.parsed.outputs.files }}"
            printf "-- Fun Market"
          )

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            --data-urlencode text="$MESSAGE"

      - name: Step 9 - Done
        run: echo "âœ… All services refreshed successfully"
