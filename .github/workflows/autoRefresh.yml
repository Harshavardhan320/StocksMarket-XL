name: Auto Wake and Refresh All Services

permissions:
  contents: read

on:
  schedule:
    # 10:30 PM IST = 17:00 UTC
    - cron: "0 17 * * *"
  workflow_dispatch:

jobs:
  wake-and-refresh:
    runs-on: ubuntu-latest

    steps:
      - name: Wake Config Server
        run: curl -s https://funmarketconfigserver-dckt.onrender.com/actuator/health || true

      - name: Wake DB Connector
        run: curl -s https://funmarketdb.onrender.com/actuator/health || true

      - name: Wake Git Reader
        run: curl -s https://funmarketgitreader.onrender.com/actuator/health || true

      - name: Wait for services
        run: sleep 300

      - name: Trigger Git Reader Load
        run: |
          curl -s -X POST \
            https://funmarketgitreader.onrender.com/fun-market/git-reader/read \
            -o response.json

      - name: Parse response using Python
        id: parsed
        run: |
          python3 << 'EOF'
          import json
          from datetime import datetime, timedelta
          import os

          # Defaults
          message = "No message returned"
          status = "NA"
          files = ["No files processed"]

          # Read response
          try:
              with open("response.json", "r", encoding="utf-8") as f:
                  data = json.load(f)

              message = data.get("message", message)
              status = str(data.get("httpStatusCode", status))

              raw_files = data.get("data")
              if isinstance(raw_files, list):
                  files = raw_files
              elif isinstance(raw_files, str):
                  files = [raw_files]

          except Exception:
              message = "Non-JSON or invalid response received"
              status = "ERROR"
              files = ["Response was not valid JSON"]

          # Format file list
          formatted_files = "\n".join(f"â€¢ {f}" for f in files)

          # IST time
          ist = datetime.utcnow() + timedelta(hours=5, minutes=30)
          day = ist.strftime("%A")
          datetime_str = ist.strftime("%d %B %Y, %I:%M %p IST")

          alert = ""
          if day in ("Saturday", "Sunday"):
              alert = "ðŸš¨ ALERT: This execution happened on a weekend."

          # Write outputs
          with open(os.environ["GITHUB_OUTPUT"], "a") as out:
              out.write(f"message={message}\n")
              out.write(f"status={status}\n")
              out.write("files<<EOF\n")
              out.write(f"{formatted_files}\n")
              out.write("EOF\n")
              out.write(f"day={day}\n")
              out.write(f"datetime={datetime_str}\n")
              out.write(f"alert={alert}\n")
          EOF

      - name: Send Email Notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          secure: false
          subject: "Fun Market â€“ Git Data Load Report"
          to: funstockmarket365@gmail.com,katukojwalaharshavardhan97@gmail.com,ankithachikki123@gmail.com
          from: "Fun Market Automation <sunnyharsha320@gmail.com>"
          body: |
            FUN MARKET â€“ GIT DATA LOAD REPORT

            Date & Time : ${{ steps.parsed.outputs.datetime }}
            Day         : ${{ steps.parsed.outputs.day }}

            ${{ steps.parsed.outputs.alert }}

            Execution Message:
            ${{ steps.parsed.outputs.message }}

            Status Code:
            ${{ steps.parsed.outputs.status }}

            Files Processed:
            ${{ steps.parsed.outputs.files }}

            --
            Fun Market Automation System

      - name: Send Telegram Notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          TEXT="<b>ðŸ“¢ FUN MARKET â€“ GIT DATA LOAD REPORT</b>

          <b>ðŸ—“ Date & Time:</b> ${{ steps.parsed.outputs.datetime }}
          <b>ðŸ“… Day:</b> ${{ steps.parsed.outputs.day }}
          
          ${{ steps.parsed.outputs.alert }}
          
          <b>ðŸ“¨ Execution Message:</b>
          <i>${{ steps.parsed.outputs.message }}</i>
          
          <b>ðŸ“Š Status Code:</b> ${{ steps.parsed.outputs.status }}
          
          <b>ðŸ“‚ Files Processed:</b>
          ${{ steps.parsed.outputs.files }}
          
          <i>ðŸ¤– Fun Market Automation System</i>"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode=HTML \
            --data-urlencode text="$TEXT"
