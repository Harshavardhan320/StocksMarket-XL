name: Auto Wake and Refresh All Services

on:
  schedule:
    # Run Mondayâ€“Friday at 11:30 PM IST
    # IST = UTC + 5:30 â†’ 23:30 IST = 18:00 UTC
    - cron: "0 18 * * 1-5"

jobs:
  wake-and-refresh:
    # Ensure job runs ONLY on main branch
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: Step 1 - Wake up Config Server
        run: |
          echo "ðŸ“¡ Waking up Config Server..."
          curl -s -o /dev/null https://funmarketconfigserver-dckt.onrender.com/actuator/health &

      - name: Step 2 - Wake up DB Service
        run: |
          echo "ðŸ“¡ Waking up Stock Market DB Service..."
          curl -s -o /dev/null https://funmarketdb.onrender.com/actuator/health &

      - name: Step 3 - Wake up Git Reader Service
        run: |
          echo "ðŸ“¡ Waking up Git Reader Service..."
          curl -s -o /dev/null https://funmarketgitreader.onrender.com/actuator/health &

      - name: Step 4 - Wait 4.5 minutes
        run: |
          echo "â³ Waiting 270 seconds..."
          sleep 270

      - name: Step 5 - Stabilize network
        run: |
          echo "ðŸ’¤ Sleeping 10 seconds..."
          sleep 10

      - name: Step 6 - Trigger Git Reader Refresh
        id: gitreader
        run: |
          echo "ðŸš€ Triggering Git Reader Refresh..."
          RESPONSE=$(curl -s -X POST https://funmarketgitreader.onrender.com/fun-market/git-reader/read || echo '{"message":"Request failed","data":[],"httpStatusCode":500}')
          echo "response=$RESPONSE" >> $GITHUB_OUTPUT

      - name: Step 7 - Parse Response JSON
        id: parsed
        run: |
          MESSAGE="${{ fromJson(steps.gitreader.outputs.response).message }}"
          STATUS="${{ fromJson(steps.gitreader.outputs.response).httpStatusCode }}"
          DATA_RAW='${{ toJson(fromJson(steps.gitreader.outputs.response).data) }}'
          DATA=$(echo "$DATA_RAW" | tr -d '\n' | tr -d '\r')

          echo "message=$MESSAGE" >> $GITHUB_OUTPUT
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "data=$DATA" >> $GITHUB_OUTPUT

      - name: Step 8 - Send Email Report
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          secure: false
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: Fun Market - Nightly Git Reader Refresh Result
          to: funstockmarket365@gmail.com, katukojwalaharshavardhan97@gmail.com, ankithachikki123@gmail.com
          from: "Fun Market Bot <sunnyharsha320@gmail.com>"
          body: |
            Hello Fun Market Team,

            The scheduled Git Reader refresh (11:30 PM IST, Monâ€“Fri) has completed.

            **Message:**  
            ${{ steps.parsed.outputs.message }}

            **Status Code:**  
            ${{ steps.parsed.outputs.status }}

            **Data:**  
            ${{ steps.parsed.outputs.data }}

            Regards,  
            Fun Market Automation System

      - name: Step 9 - Done
        run: echo "ðŸŽ‰ Completed Successfully!"
