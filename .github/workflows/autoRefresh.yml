name: Auto Wake and Refresh All Services

on:
  push:
    branches:
      - main

jobs:
  wake-and-refresh:
    runs-on: ubuntu-latest

    steps:
      - name: Step 1 - Wake up Config Server
        run: |
          echo "ðŸ“¡ Waking up Config Server..."
          curl -s -o /dev/null https://funmarketconfigserver-dckt.onrender.com/actuator/health &

      - name: Step 2 - Wake up DB Service
        run: |
          echo "ðŸ“¡ Waking up Stock Market DB Service..."
          curl -s -o /dev/null https://funmarketdb.onrender.com/actuator/health &

      - name: Step 3 - Wake up Git Reader Service
        run: |
          echo "ðŸ“¡ Waking up Git Reader Service..."
          curl -s -o /dev/null https://funmarketgitreader.onrender.com/actuator/health &

      - name: Step 4 - Wait 5 minutes for all services to start
        run: |
          echo "â³ Waiting 300 seconds..."
          sleep 300

      - name: Step 5 - Stabilize network
        run: |
          echo "ðŸ’¤ Sleeping 20 seconds..."
          sleep 20

      - name: Step 6 - Trigger Git Reader Refresh and capture response
        id: gitreader
        run: |
          echo "ðŸš€ Triggering Git Reader CSV â†’ Mongo Refresh..."
          RESPONSE=$(curl -s -X POST https://funmarketgitreader.onrender.com/fun-market/git-reader/read || echo "Request failed")
          echo "Server response: $RESPONSE"
          # Export as GitHub Action output
          echo "response=$RESPONSE" >> $GITHUB_OUTPUT

      - name: Step 7 - Send response via email
        uses: dawidd6/action-send-mail@v3
        with:
          server: ${{ secrets.SMTP_SERVER }}
          port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          secure: true
          subject: Fun Market - Git Reader Refresh Result
          to: funstockmarket365@gmail.com
          from: "Fun Market Bot <funstockmarket365.notify@outlook.com>"
          body: |
            Hello fun market team,

            The Git Reader API has finished running.

            Here is the response returned by the server:

            ${{ steps.gitreader.outputs.response }}

            Regards,
            Fun Market Automation System

      - name: Step 8 - Done
        run: echo "ðŸŽ‰ Completed Successfully!"
